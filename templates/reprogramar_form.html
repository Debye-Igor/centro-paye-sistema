{% extends "base.html" %}

{% block title %}Reprogramar Cita - Centro Paye{% endblock %}
{% block page_title %}Reprogramar Cita{% endblock %}

{% block content %}
<div class="content">
    <h2>Reprogramar Cita: {{ cita_original.paciente }}</h2>
    
    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
        <h3>Informaci贸n Original:</h3>
        <p><strong>Paciente:</strong> {{ cita_original.paciente }}</p>
        <p><strong>Fecha Original:</strong> {{ cita_original.fecha_original }} a las {{ cita_original.hora_original }}</p>
        <p><strong>Servicio:</strong> {{ cita_original.servicio }}</p>
        <p><strong>Profesional Original:</strong> {{ cita_original.profesional }}</p>
    </div>

    <form method="POST">
        <input type="hidden" name="cita_id" value="{{ cita_original.id }}">
        
        <div class="form-group">
            <label for="nueva_fecha">Nueva Fecha *</label>
            <input type="date" id="nueva_fecha" name="nueva_fecha" required 
                   min="{{ fecha_minima }}" value="{{ fecha_sugerida }}">
        </div>

        <div class="form-group">
            <label for="nueva_hora">Nueva Hora *</label>
            <select id="nueva_hora" name="nueva_hora" required>
                <option value="">Seleccionar hora</option>
                {% for hora in horarios_disponibles %}
                <option value="{{ hora }}">{{ hora }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="profesional_id">Profesional *</label>
            <select id="profesional_id" name="profesional_id" required>
                <option value="{{ cita_original.profesional_id }}" selected>
                    {{ cita_original.profesional }} (Mismo profesional)
                </option>
                {% for profesional in otros_profesionales %}
                <option value="{{ profesional.id }}">{{ profesional.nombre }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="observaciones">Observaciones de la Reprogramaci贸n</label>
            <textarea id="observaciones" name="observaciones" rows="3" 
                      placeholder="Motivo de la reprogramaci贸n, cambios, etc..."></textarea>
        </div>

        <button type="submit" class="btn-primary">Confirmar Reprogramaci贸n</button>
        <a href="{{ url_for('reprogramaciones.reprogramaciones') }}" class="btn-secondary">Cancelar</a>
    </form>
</div>

<script>
document.getElementById('nueva_fecha').addEventListener('change', function() {
    const fecha = this.value;
    const selectHora = document.getElementById('nueva_hora');
    
    if (!fecha) {
        selectHora.innerHTML = '<option value="">Seleccionar hora</option>';
        return;
    }
    
    // Mostrar loading en camo de horas
    selectHora.innerHTML = '<option value="">Cargando horarios...</option>';
    
    // peticion para obtener horarios de esta fecha
    fetch('/api/horarios-fecha', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ fecha: fecha })
    })
    .then(response => response.json())
    .then(data => {
        selectHora.innerHTML = '<option value="">Seleccionar hora</option>';
        
        if (data.horarios && data.horarios.length > 0) {
            data.horarios.forEach(hora => {
                const option = document.createElement('option');
                option.value = hora;
                option.textContent = hora;
                selectHora.appendChild(option);
            });
        } else {
            selectHora.innerHTML = '<option value="">No hay horarios disponibles</option>';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        selectHora.innerHTML = '<option value="">Error cargando horarios</option>';
    });
});
</script>

{% endblock %}