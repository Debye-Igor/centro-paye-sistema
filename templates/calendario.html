{% extends "base.html" %}

{% block title %}Calendario - Centro Paye{% endblock %}
{% block page_title %}Calendario de Citas{% endblock %}

{% block content %}
<div class="content">
    <!-- Navegación de semana -->
    <div class="calendario-header">
        <button class="btn-nav" onclick="navegarSemana('{{ semana_anterior }}')">←</button>
        <h2>Semana del {{ dias[0]['fecha'].day }} al {{ dias[6]['fecha'].day }} de {{ mes_espanol }} {{
            dias[0]['fecha'].year }}</h2>
        <button class="btn-nav" onclick="navegarSemana('{{ semana_siguiente }}')">→</button>
    </div>

    <!-- Grilla del calendario -->
    <div class="calendario-container">
        <table class="calendario-table">
            <thead>
                <tr>
                    <th class="hora-column">Hora</th>
                    {% for dia in dias %}
                    <th class="dia-column">{{ dia.dia_nombre }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for hora in horarios %}
                <tr>
                    <td class="hora-cell">{{ hora }}</td>
                    {% for dia in dias %}
                    <td class="cita-cell">
                        {% set cita_key = dia.fecha_str + '_' + hora %}
                        {% if citas.get(cita_key) %}
                        <!-- Hay una cita programada -->
                        <div class="cita-programada">
                            <strong>{{ citas[cita_key].paciente }}</strong><br>
                            <small>{{ citas[cita_key].servicio }}</small><br>
                            <small>{{ citas[cita_key].profesional }}</small>
                            <div class="cita-acciones">
                                <button
                                    onclick="reprogramarCita('{{ citas[cita_key].id }}', '{{ citas[cita_key].paciente }}')"
                                    class="btn-reprogramar">Reprogramar</button>
                                <button
                                    onclick="eliminarCita('{{ citas[cita_key].id }}', '{{ citas[cita_key].paciente }}')"
                                    class="btn-eliminar-cita">Eliminar</button>
                            </div>
                        </div>
                        {% else %}
                        <!-- Horario libre -->
                        <button class="btn-agregar-cita" onclick="nuevaCita('{{ dia.fecha_str }}', '{{ hora }}')">
                            + Agendar
                        </button>
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function nuevaCita(fecha, hora) {
        // Redirigir al formulario de nueva cita
        window.location.href = `/citas/nueva?fecha=${fecha}&hora=${hora}`;
    }


    function reprogramarCita(citaId, paciente) {
        const motivo = prompt(`¿Motivo para reprogramar la cita de "${paciente}"?`, '');

        if (motivo && motivo.trim() !== '') {
            // Formulario con el motivo
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/citas/${citaId}/reprogramar`;

            // Agregar campo motivo
            const motivoInput = document.createElement('input');
            motivoInput.type = 'hidden';
            motivoInput.name = 'motivo';
            motivoInput.value = motivo.trim();
            form.appendChild(motivoInput);

            document.body.appendChild(form);
            form.submit();
        }
    }

    function eliminarCita(citaId, paciente) {
        if (confirm(`¿Eliminar definitivamente la cita de "${paciente}"?\n\nEsta acción no se puede deshacer.`)) {
            // Enviar solicitud para eliminar
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/citas/${citaId}/eliminar`;

            document.body.appendChild(form);
            form.submit();
        }
    }

    function navegarSemana(fechaInicio) {
        window.location.href = `/calendario?fecha_inicio=${fechaInicio}`;
    }

</script>
{% endblock %}